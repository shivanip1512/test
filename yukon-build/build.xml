<?xml version="1.0" ?>
<project name="Yukon CruiseControl Ant Build Script" default="targets" basedir="..">

    <property environment="env" />
    <tstamp/>
	<tstamp>
	    <format property="currenttime" pattern="yyyy-MM-dd HH:mm:ss z" locale="en,US"/>
    </tstamp>
    <property name="module.name" value="yukon" />
    <property name="log.dir" value="./logs" />
    <property name="dist.dir" value="./dist" />
    <property name="temp.dir" value="./temp" />

    <target name="targets">
        <echo message="The following targets are available" />
        <echo message=""/>
        <echo message=" checkout				- cvs checkout" />
        <echo message="" />
        <echo message=" update					- cvs update" />
        <echo message=" update-client			- cvs update yukon-client module" />
        <echo message=" update-server			- cvs update yukon-server module" />
        <echo message="" />
        <echo message=" clean					- delete everything and start over clean" />
        <echo message=" cleandist				- delete old packages and zip files" />
        <echo message="" />
        <echo message=" build					- clean, checkout, compile, and package everything" />
        <echo message=" buildquick				- cvs update, compile and package everything" />
        <echo message=" build-client			- cvs update, and compile yukon-client module" />
        <echo message=" build-server			- cvs update, and compile yukon-server module" />
        <echo message=" build-install			- InstallShield"/>
        <echo message=" builddist				- packages and zips everything up for distribution " />
        <echo message="" />
        <echo message=" tag-build				- build then tag"/>
        <echo message=" branch-build			- build then branch and tag"/>
        <echo message=""/>
        <echo message=" tag						- tags cvs HEAD"/>
        <echo message=" branch					- branchs cvs HEAD then tags branch"/>
        <echo message=""/>
    </target>

	<target name="init" depends="check-setupcustomtasks,setupcustomtasks,cleanwhitespace,loadpropertiesfile,cleanlabels">
	
	    <condition property="internal.label" value="${internal}-${label}" else="${internal}">
    	    <isset property="label"/>
	    </condition>
    
    	<property name="yukon.build.label" value="${external}"/>
    	<property name="yukon.build.details" value="BUILD ${internal.label} ${currenttime} ${env.COMPUTERNAME} ${branch}"/>

	</target>
    
    <target name="setupcustomtasks" unless="setupExists">
        <delete dir="yukon-build/build"/>
        
        <mkdir dir="yukon-build/build"/>
        
        <mkdir dir="yukon-build/build/classes"/>
    	<javac srcdir="yukon-build/src"
        	   destdir="yukon-build/build/classes"
               classpath="yukon-build/lib/ant.jar"
               fork="true"
        	   debug="on"/>
        
        <mkdir dir="yukon-build/build/dist"/>
        <jar destfile="yukon-build/build/dist/customtasks.jar"
        	 basedir="yukon-build/build/classes"
        	 includes="**/*.class"/>
    </target>
    
    <target name="check-setupcustomtasks">
        <condition property="setupExists">
            <available file="yukon-build/build/dist/customtasks.jar"/>
        </condition>
    </target>
    
    <target name="cleanwhitespace">

    	<taskdef name="cleanwhitespace" 
                 classname="com.cannontech.customtasks.CleanWhiteSpace"
                 classpath="yukon-build/build/dist/customtasks.jar"/>
    
    	<cleanwhitespace file="yukon-build/build_version.properties"/>

    </target>
    
    <target name="loadpropertiesfile">
        <property file="yukon-build/build_version.properties"/>
    </target>
        
    <target name="cleanlabels">

        <taskdef name="regexprop" 
                 classname="com.cannontech.customtasks.RegexReplaceProperty"
                 classpath="yukon-build/build/dist/customtasks.jar"/>
        
        <regexprop name="cleaninternal" 
        	   value="${internal}"
               match = "[^a-zA-Z0-9]"
        	   replace="_"/>

        <regexprop name="cleanexternal" 
        	   value="${external}"
        	   match="[^a-zA-Z0-9]"
        	   replace="_"/>
        
    </target>
    
    <target name="checkout" depends="init">
        <echo message="checking out module yukon by tag or branch: ${branch}" />
        <cvs tag="${branch}"
             package="${module.name}"
             reallyquiet="false"/>
    </target>

    <target name="update" depends="init">
        <echo message="updating module yukon by timestamp: ${currenttime}" />
        <cvs dest="${module.name}" 
             command="update -A -d" 
             reallyquiet="false"
             date="${currenttime}"/>
    </target>

    <target name="update-client" depends="init">
        <echo message="updating module yukon-client by timestamp: ${currenttime}" />
        <cvs dest="${module.name}/yukon-client" 
             command="update -A -d" 
             reallyquiet="false"
        	 date="${currenttime}"/>
    </target>

    <target name="update-server" depends="init">
        <echo message="updating module yukon-server by timestamp: ${currenttime}" />
        <cvs dest="${module.name}/yukon-server" 
             command="update -A -d"
             reallyquiet="false"
             date="${currenttime}"/>
    </target>

    <target name="build" depends="clean,checkout,buildTarget,builddist" />
    <target name="buildTarget" depends="build-clientTarget,build-serverTarget,build-installTarget" />

    <target name="build-client" depends="update-client,build-clientTarget" />
    <target name="build-clientTarget">
        <echo message="building module yukon-client" />
        <mkdir dir="${log.dir}" />

        <exec failonerror="false" dir="${module.name}/yukon-client/build" executable="cmd.exe" error="${log.dir}/client-error.log" output="${log.dir}/client-output.log" resultproperty="errorcode">
            <arg line='/c antExit.bat -Dyukon.build.version="${yukon.build.label}" -Dyukon.build.details="${yukon.build.details}" clean build'/>
        </exec>

        <loadfile property="errormessage" srcFile="${log.dir}/client-error.log" />
        <loadfile property="erroroutput" srcFile="${log.dir}/client-output.log" />

        <condition property="out" value="${erroroutput}" else="">
            <isfailure code="${errorcode}"/>
        </condition>

        <echo message="${out}" />

        <fail message="${errormessage}">
            <condition>
                <isfailure code="${errorcode}" />
            </condition>
        </fail>

        <!-- yukon-help.jar -->
        <ant dir="${module.name}/yukon-client/build"
        	 target="help"
        	 inheritAll="true"/>
        
        <antcall target="runUnitTests" />

        <antcall target="signclient" />

    </target>


    <target name="build-server" depends="update-server,build-serverTarget" />
    <target name="build-serverTarget">
        <echo message="building module yukon-server" />
        <mkdir dir="${log.dir}" />

        <exec failonerror="false" dir="${module.name}/yukon-server/" executable="cmd.exe" error="${log.dir}/server-error.log" output="${log.dir}/server-output.log" resultproperty="errorcode">
            <arg line='/c ${basedir}\yukon-build\buildhere.cmd /exit /basedir "${basedir}" /labels "${yukon.build.label}" "${yukon.build.details}"' />
        </exec>

        <loadfile property="errormessage" srcFile="${log.dir}/server-error.log" />
        <loadfile property="erroroutput" srcFile="${log.dir}/server-output.log" />

        <condition property="out" value="${erroroutput}" else="">
            <isfailure code="${errorcode}"/>
        </condition>

        <echo message="${out}" />

        <fail message="${errormessage}">
            <condition>
                <isfailure code="${errorcode}" />
            </condition>
        </fail>

        <!-- C++ Unit Tests -->
        <mkdir dir="${module.name}/yukon-server/bin/unittests"/>
        <exec failonerror="false" dir="${module.name}/yukon-server/bin/" executable="cmd.exe" error="${log.dir}/servertests-error.log" output="${log.dir}/servertests-output.log" resultproperty="testserrorcode">
            <arg line="/c runalltestsexit.cmd unittests/"/>
        </exec>

        <loadfile property="testserrormessage" srcFile="${log.dir}/servertests-error.log" />
        <loadfile property="testserroroutput" srcFile="${log.dir}/servertests-output.log" />

        <condition property="testsout" value="${testerroroutput}" else="">
            <isfailure code="${testserrorcode}"/>
        </condition>

        <echo message="${testsout}" />

        <fail message="${testserrormessage}">
            <condition>
                <isfailure code="${testserrorcode}" />
            </condition>
        </fail>
    </target>

    <target name="build-install" depends="build-installTarget"/>
    <target name="build-installTarget">
        <echo message="building module yukon-install" />
        <mkdir dir="${log.dir}" />
		
        <property name="client.bag" value="${module.name}/yukon-client/lib" />
        <property name="install.bag" value="${module.name}/yukon-install/build" />
        <property name="server.bag" value="${module.name}/yukon-server/bin" />
        
        <!-- Yukon Base Component -->
        <delete dir="${install.bag}"/>
        <mkdir dir="${install.bag}/Yukon Base"/>
        
        <!-- Yukon Base Component (Client) -->
        <property name="client.dir" value="${install.bag}/Yukon Base/Client"/>
        <property name="client.bin" value="${client.dir}/bin"/>
        <mkdir dir="${client.dir}"/>
       	<mkdir dir="${client.dir}/Export"/>
       	<mkdir dir="${client.dir}/Log"/>
        
        <copy todir="${client.bin}" preservelastmodified="true">
            <fileset dir="${client.bag}" excludes="*.txt,*.xml,*.properties,*.debug,images/**,commands/**"/>
            <fileset file="${module.name}/yukon-client/monitor/resource/YukonNoAlarm.ico" />
            <fileset file="${module.name}/yukon-client/monitor/resource/AlarmMonitor.ico" />
            <fileset file="${module.name}/yukon-client/trending/resource/GraphIcon.ico"/>
            <fileset file="${module.name}/yukon-client/dbeditor/resource/dbEditorIcon.ico"/>
            <fileset file="${module.name}/yukon-client/tdc/resource/tdcIcon.ico"/>
            <fileset file="${module.name}/yukon-client/commander/resource/CommanderIcon.ico"/>
        </copy>
       	    
        <!-- Yukon Base Component (Server) -->      
        <property name="server.dir" value="${install.bag}/Yukon Base/Server"/>
        <property name="server.bin" value="${server.dir}/bin"/>
        <mkdir dir="${server.dir}"/>
		
        <copy todir="${server.bin}" preservelastmodified="true">
			<fileset dir="${server.bag}" excludes="unittests/**"/>
            <fileset dir="${module.name}/yukon-install/resources/common_dlls" />
		</copy>
        
        <copy todir="${server.dir}/MACSscripts" file="${server.bag}/init.tcl" preservelastmodified="true"/>
        <mkdir dir="${server.dir}/MACSftp"/>
        <mkdir dir="${server.dir}/Export"/>
        <mkdir dir="${server.dir}/Import"/>
        <mkdir dir="${server.dir}/Log"/>
        
        <!-- Initial Server Config Component -->
        <copy todir="${install.bag}/Initial Server Config/Config" file="${module.name}/yukon-install/resources/master.cfg" preservelastmodified="true"/>

        <!-- Config Properties Component -->
        <copy todir="${install.bag}/Config Properties" preservelastmodified="true">
            <fileset dir="${module.name}/yukon-install/resources" includes="*Logging.xml," casesensitive="false">
            </fileset>
        </copy>
        
        <!-- Common Directories Component -->
        <copy todir="${install.bag}/Common Directories/Config/Example" file="${module.name}/yukon-install/resources/master.cfg" preservelastmodified="true"/>
        
        <!-- JRE 1.5 Component -->
        <copy todir="${install.bag}/JRE 1.5" preservelastmodified="true">
            <fileset dir="${module.name}/yukon-install/JRE" />
        </copy>

        <!-- Tomcat Component -->
        <copy todir="${install.bag}/Tomcat" preservelastmodified="true">
            <fileset dir="${module.name}/yukon-install/Tomcat5" />
        </copy>

        <!-- WebStart Component -->
        <copy todir="${install.bag}/WebStartJRE" preservelastmodified="true">
            <fileset dir="${module.name}/yukon-install/WebStartJRE" />
        </copy>

        <!-- Yukon Web Deployment Component -->
        <copy todir="${install.bag}/Yukon Web Deployment/bin" preservelastmodified="true">
            <fileset dir="${module.name}/yukon-install/JRE/bin" includes="jar.exe,hpi.dll,java.dll,verify.dll,zip.dll" />
            <fileset file="${client.bag}/yukon.war" />
        </copy>
        <copy todir="${install.bag}/Yukon Web Deployment/bin/client" file="${module.name}/yukon-install/JRE/bin/client/jvm.dll" preservelastmodified="true"/>
        <copy todir="${install.bag}/Yukon Web Deployment/lib" file="${module.name}/yukon-install/JRE/lib/rt.jar" preservelastmodified="true"/>
        <copy todir="${install.bag}/Yukon Web Deployment/lib/i386" file="${module.name}/yukon-install/JRE/lib/i386/jvm.cfg" preservelastmodified="true"/>

        <!-- Wrapper files -->
        <copy todir="${install.bag}/Wrapper/Client/bin" preservelastmodified="true">
            <fileset dir="${install.bag}/Yukon Base/Client/bin" includes="*.exe,*.conf,*.dll"/>
        </copy>
        
        <!-- This will be pointing to the install engine in yukon-install module -->
        <!--  <property name="isshield" location="C:\Program Files\Macrovision\IS12\System\IsCmdBld.exe" /> -->
        <property name="isshield" value="IsSABld.exe" />
        <!-- <property name="isfile" location="yukon-build/Yukon Installer/Yukon Installer.ism" /> -->
        <property name="isfile" location='${module.name}\yukon-install\YukonSetupX\Yukon Installer.ism' />

        <exec failonerror="false" executable="${isshield}" error="${log.dir}/install-error.log" output="${log.dir}/install-output.log" resultproperty="errorcode">
            <arg line="-p '${isfile}'" />
        </exec>

        <!-- NOT YET <delete dir="${install.lib}"/> NOT YET -->

        <loadfile property="errormessage" srcFile="${log.dir}/install-error.log" />
        <loadfile property="erroroutput" srcFile="${log.dir}/install-output.log" />

        <condition property="out" value="${erroroutput}" else="">
            <length file="${log.dir}/install-error.log" when="ne" length="0" />
        </condition>

        <length file="${log.dir}/install-error.log" property="file.length" />

        <echo message="${out}" />

        <fail message="${errormessage}">
            <condition>
                <isfailure code="${errorcode}" />
            </condition>
        </fail>
    </target>

    <target name="builddist" depends="updatedbscripts">
        <mkdir dir="${temp.dir}" />
        <copy todir="${temp.dir}/installer">
            <fileset dir="${module.name}/yukon-install/YukonSetupX/Media/CD/Disk Images/Disk1" />
        </copy>
        <copy todir="${temp.dir}/eSubImages">
            <fileset dir="${module.name}/yukon-client/esub/images" />
        </copy>
        <copy todir="${temp.dir}/YukonDatabase/DatabaseCreation">
            <fileset dir="${module.name}/yukon-database/CreationScripts" />
        </copy>
        <copy todir="${temp.dir}/YukonDatabase/DatabaseUpdates/Oracle">
            <fileset dir="${module.name}/yukon-database/DBUpdates/oracle" />
        </copy>
        <copy todir="${temp.dir}/YukonDatabase/DatabaseUpdates/SqlServer">
            <fileset dir="${module.name}/yukon-database/DBUpdates/sqlserver" />
        </copy>
        
        <mkdir dir="${dist.dir}" />
        
        <zip destfile="${dist.dir}/yukon_${DSTAMP}_${cleaninternal}_${cleanexternal}_${TSTAMP}.zip">
            <fileset dir="${temp.dir}" />
        </zip>

        <delete dir="${temp.dir}" />
    </target>

    <target name="cleandist">
        <delete dir="${dist.dir}" />
    </target>

    <target name="clean">
        <delete dir="${module.name}" />
        <delete dir="${dist.dir}" />
        <delete dir="${log.dir}" />
    </target>

    <target name="runUnitTests">
        <exec failonerror="true" dir="${module.name}/yukon-client/build" executable="cmd.exe">
            <arg line="/c antExit.bat -Dyukon.build.version='${yukon.build.label}' runUnitTests" />
        </exec>
    </target>

    <target name="signclient">
        <exec failonerror="true" dir="${module.name}/yukon-client/build" executable="cmd.exe">
            <arg line="/c antExit.bat sign" />
        </exec>
    </target>

    <target name="tag-build" depends="init">
        <property name="tag.name" value="TG${DSTAMP}_${cleaninternal}_${cleanexternal}_${TSTAMP}"/>
        
        <input
          message="tag: ${tag.name}		continue?"
          validargs="y,n"
          addproperty="do.tag"/>
        
        <condition property="do.abort">
          <equals arg1="n" arg2="${do.tag}"/>
        </condition>
        <fail if="do.abort">Build aborted by user.</fail>
		
		<antcall target="build"/>
		<antcall target="tag"/>
		
    </target>
    
    <target name="branch-build" depends="init">
		<property name="branch.name" value="BR${DSTAMP}_${cleaninternal}_${cleanexternal}_${TSTAMP}"/>
        <property name="tag.name" value="TG${DSTAMP}_${cleaninternal}_${cleanexternal}_${TSTAMP}"/>
        
        <input
          message="branch: ${branch.name}	tag: ${tag.name}	continue?"
          validargs="y,n"
          addproperty="do.tag"/>
        
        <condition property="do.abort">
          <equals arg1="n" arg2="${do.tag}"/>
        </condition>
        <fail if="do.abort">Build aborted by user.</fail>
		
		<antcall target="build"/>
		<antcall target="branch"/>
		
    </target>
    
    <target name="tag">
		<antcall target="tag-cvsexecute"/>
        <antcall target="symstore"/>
    </target>
    
    <target name="tag-cvsexecute">
        <echo message="command: rtag -D '${currenttime}' ${tag.name} ${module.name}"/>
        <cvs command="rtag -D '${currenttime}' ${tag.name} ${module.name}"/>   
    </target>
    
    <target name="branch">
        <antcall target="branch-cvsexecute"/>
        <antcall target="tag-cvsexecute"/>
        
        <replace file="yukon-build/build_version.properties" token="branch = ${branch}" value="branch = ${branch.name}"/>
        <cvs command='commit -m "branch property update" -r ${branch} yukon-build/build_version.properties'/>

        <antcall target="updatedbscripts-cvsexecute"/>
        
        <antcall target="symstore"/>

    </target>
    
    <target name="branch-cvsexecute">
        <echo message="command: rtag -b -D '${currenttime}' ${branch.name} ${module.name}"/>
        <cvs command="rtag -b -D '${currenttime}' ${branch.name} ${module.name}"/>
    </target>
        
    <target name="symstore">
        <exec failonerror="false" dir="yukon-build/symbolserver/" executable="cmd.exe">
            <arg line='/c symstore add /r /f ${basedir}\${module.name}\yukon-server\*.PDB /s \\swbuild\symbol /t "Yukon Server" /v "${yukon.build.details}"'/>
        </exec>   
    </target>
        
    <target name="updatedbscripts">
    	<taskdef name="createdbversions" 
                 classname="com.cannontech.customtasks.CreateDBVersions"
                 classpath="yukon-build/build/dist/customtasks.jar"/>
        
        <createdbversions buildlabel="${internal}"/>
        
        <ant dir="${module.name}/yukon-database"
             target="build"
             inheritAll="false"
             inheritRefs="false">
        	<property name="yukon.major" value="${yukon.major}"/>
        	<property name="yukon.minor" value="${yukon.minor}"/>
        	<property name="yukon.revision" value="${yukon.revision}"/>
        </ant>
        
    </target>
    
    <target name="updatedbscripts-cvsexecute">
        <property name="sqlfilename" value="${yukon.major}.${yukon.minor}_${yukon.revision}.sql"/>
        <cvs command='commit -m "branch yukon version update" -r ${branch} ${module.name}/yukon-database/DBUpdates/sqlserver/${sqlfilename}'/>
        <cvs command='commit -m "branch yukon version update" -r ${branch} ${module.name}/yukon-database/DBUpdates/oracle/${sqlfilename}'/>
        <cvs command='commit -m "branch yukon version update" -r HEAD ${module.name}/yukon-database/DBUpdates/sqlserver/${sqlfilename}'/>
        <cvs command='commit -m "branch yukon version update" -r HEAD ${module.name}/yukon-database/DBUpdates/oracle/${sqlfilename}'/>
    </target>
    
</project>
