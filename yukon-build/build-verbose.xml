<?xml version="1.0" ?>
<project name="Yukon CruiseControl Ant Build Script" basedir="..">

    <property file="yukon-build/build_version.properties"/>
    <property environment="env" />
    <tstamp/>
	<tstamp>
	    <format property="currenttime" pattern="yyyy-MM-dd HH:mm:ss z" locale="en,US"/>
    </tstamp>
    <property name="module.name" value="yukon" />
    
    <target name="init">
	    <!-- Clean trailing white space -->
        <replaceregexp file="yukon-build/build_version.properties"
            				   flags="g"
                               match="\s+$"
                               replace=""
                               byline="true"/>
	    
	    <condition property="internal.label" value="${internal}-${label}" else="${internal}">
    	    <isset property="label"/>
	    </condition>
    
    	<property name="yukon.build.label" value="${external}"/>
    	<property name="yukon.build.details" value="BUILD ${internal.label} ${currenttime} ${env.COMPUTERNAME} ${branch}"/>
	</target>
	
	<target name="init-cleanlabels">
        <exec failonerror="true" executable="cmd">
            <arg value="cmd /c echo cleaninternal = ${internal} > yukon-build\cleanversion.properties"/>
        </exec>
       	<exec failonerror="true" executable="cmd">
	       	 <arg value="cmd /c echo cleanexternal = ${external} >> yukon-build\cleanversion.properties"/>
       	</exec>

        <replaceregexp file="yukon-build/cleanversion.properties"
            				   flags="g"
                               match="[^a-zA-Z0-9=_\s]"
                               replace="_"
                               byline="true"/>
        <replaceregexp file="yukon-build/cleanversion.properties"
            				   flags="g"
                               match="\s+$"
                               replace=""
                               byline="true"/>
        
     	<property file="yukon-build/cleanversion.properties"/>
    </target>
    
    <target name="checkout-client" depends="init">
        <echo message="checking out module yukon-client by tag or branch: ${branch}" />
        <cvs tag="${branch}"
        	 dest="${module.name}"
             package="yukon-client"/>
    </target>
    
    <target name="checkout-server" depends="init">
        <echo message="checking out module yukon-server by tag or branch: ${branch}" />
        <cvs tag="${branch}"
        	 dest="${module.name}"
             package="yukon-server"/>
    </target>
    
    <target name="update-client" depends="init">
    	<echo message="updating module yukon-client by tag or branch: ${branch}" />
    	<cvs dest="${module.name}" package="yukon-client"/>
    </target>
    
    <target name="update-server" depends="init">
    	<echo message="updating module yukon-server by tag or branch: ${branch}" />
    	<cvs dest="${module.name}" package="yukon-server"/>
    </target>
    
    <target name="build-client" depends="update-client,build-clientTarget"/>
    <target name="build-client_noupdate" depends="init,build-clientTarget"/>
    <target name="build-clientTarget">

    	<exec failonerror="true" dir="${module.name}/yukon-client/build" executable="cmd.exe" >
            <arg line="/c antExit.bat -Dyukon.build.version='${yukon.build.label}' -Dyukon.build.details='${yukon.build.details}' clean build" />
        </exec>

    </target>
    
    <target name="build-server" depends="update-server,build-serverTarget"/>
    <target name="build-server_noupdate" depends="init,build-serverTarget"/>
    <target name="build-serverTarget">

    	<exec failonerror="true" dir="${module.name}/yukon-server/" executable="cmd.exe">
            <arg line='/c ${basedir}\yukon-build\buildhere.cmd /exit /basedir "${basedir}" /labels "${yukon.build.label}" "${yukon.build.details}"' />
        </exec>

        <mkdir dir="${module.name}/yukon-server/bin/unittests"/>

        <exec failonerror="true" dir="${module.name}/yukon-server/bin/" executable="cmd.exe">
            <arg line="/c runalltestsexit.cmd unittests/"/>
        </exec>

    </target>
    
    
</project>    