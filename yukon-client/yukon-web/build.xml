<?xml version="1.0" ?>
<!--
dir_print, jsp_build, build_webxml targets has been tested only on Windows machines
-->
<project name="yukon web" default="all">

	<property file="../build/build.properties" />
	<property name="yukon.web.src_build" value="build_src"/>
	<property name="yukon.web.jsp_build" value="build_jsp_std"/>
	<taskdef resource="net/sf/antcontrib/antcontrib.properties" />


	<target name="all" depends="clean, build">

	</target>
	
	<target name="jspcompile" depends="dir_print, jsp_build, build_webxml"/>

	<target name="dir_print">
		<mkdir dir="WebContent_temp/WEB-INF/webxml/" />


		<foreach target="jspc_tomcat" param="param.jspdir">
			<path>
				<fileset dir="${yukon-web}/WebContent">
					<include name="**/*.jsp" />
				</fileset>
			</path>
		</foreach>
	</target>




	<target name="jspc_tomcat">

		<echo message="Creating JSP implementation class for ${param.jspdir}" />
		<echo file="${yukon-web}/jsp_dir.txt" append="false">${param.jspdir}</echo>
		<loadfile srcfile="${yukon-web}/jsp_dir.txt" property="jsp.curr.package">

			<filterchain>
				<tokenfilter>
					<stringtokenizer />
					<!--filter out the dir structure up to WebContent string 
					C:\Workspace\yukon-web\WebContent\WEB-INF\layout\footer.jsp
					-->
					<replaceregex pattern="(.+\\WebContent\\)(.+)(\\.+.jsp)" replace=".\2" />
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer />
					<replaceregex pattern="\\" replace="\." />
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer />
					<replaceregex pattern="\\" replace="\." />
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer />
					<replaceregex pattern="(WEB-INF\.)" replace="" />
				</tokenfilter>
				<tokenfilter>
					<stringtokenizer />

					<!--C:.Workspace.yukon-web\WebContent\customer_profile.jsp
					C:.Workspace.yukon-web\WebContent\customer_profile.jsp;
	
					-->
					<replaceregex pattern="(.+\:\.Workspace\.yukon-web\\WebContent\\.+.jsp)" replace=" " />
				</tokenfilter>
			</filterchain>
		</loadfile>
		<echo message="Package name is org.apache.jsp${jsp.curr.package}" />
		<!--
		<taskdef classname="org.apache.jasper.JspC" name="jasper2">
			<classpath id="jspc.classpath">

				<pathelement location="../build/jasper-compiler.jar" />
				<pathelement location="../build/jasper-runtime.jar" />
				<pathelement location="../build/ant.jar" />

				<fileset dir="${yukon.lib}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="../third-party/">
					<include name="**/*.jar" />
				</fileset>


			</classpath>
		</taskdef>

		<jasper2 
			validateXml="false" 
			uriroot="C:\Workspace\yukon-web\WebContent" 
			package="org.apache.jsp${jsp.curr.package}"
			webXmlFragment="${yukon-web}/WebContent/WEB-INF/generated_web.xml" 
			outputDir="${yukon-web}/WebContent_temp" />

	-->

		<tstamp>
			<format property="time" pattern="mmssSSS" />
		</tstamp>


		<java classname="org.apache.jasper.JspC" fork="yes">
			<arg line="-v0 -webapp ${yukon-web}/WebContent/ -d ${yukon-web}/WebContent_temp
				   	-p org.apache.jsp${jsp.curr.package} -webinc ${yukon-web}/WebContent_temp/WEB-INF/webxml/onepassweb${time}.xml
					${param.jspdir}" />

			<classpath>
				<pathelement location="../build/jasper-compiler.jar" />
				<pathelement location="../build/jasper-runtime.jar" />
				<pathelement location="../build/ant.jar" />

				<fileset dir="${yukon.lib}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="../third-party/">
					<include name="**/*.jar" />
				</fileset>


			</classpath>
		</java>
		<echo message="Implementation class created." />
	</target>

	<target name="build" depends="build_src, build_jsp_std"/>

	<target name="build_jsp_std">
        <mkdir dir="${yukon.web.jsp_build}"/>
        <copy todir="${yukon.web.jsp_build}">
            <fileset dir="${yukon-web}/WebContent">
                <exclude name="build/**" />
                <exclude name="jspbuild/**" />
                <exclude name="**/CVS" />
                <exclude name="WEB-INF/web.xml" />

                <exclude name="**/.*" />
                <exclude name="**/build.xml" />
            </fileset>
        </copy>

		<!-- Put all the Yukon JAR files in here that are needed by the webserver -->
        <copy todir="${yukon.web.jsp_build}/WEB-INF/lib">
           <fileset dir="${yukon.lib}" >
              <include name="**/*.jar" />
              <exclude name="j2ee.jar"/>
           </fileset>
        </copy>

	    <war destfile="${yukon.lib}/yukon.war" basedir="${yukon.web.jsp_build}"
	        webxml="WebContent/WEB-INF/web.xml" duplicate="preserve">
	    </war>


	</target>



	<target name="build_src">

		<mkdir dir="${yukon.web.src_build}" />

		<javac srcdir="src" destdir="${yukon.web.src_build}" target="${yukon.javac.target}" 
	 	      source="${yukon.javac.source}" debug="${yukon.javac.debug}">
			<classpath>
				<fileset dir="${yukon.lib}">
					<include name="**/*.jar" />
				</fileset>
                <fileset dir="${yukon-web}/WebContent/WEB-INF/lib">
                    <include name="**/*.jar"/>
                </fileset>
			</classpath>
		</javac>

		<jar jarfile="${yukon.lib}/yukon-web.jar" basedir="${yukon.web.src_build}" />
	</target>

	<target name="install" depends="build">
		<jar jarfile="${yukon.client.bin}/yukon-web.jar" basedir="build/" />
	</target>

	<target name="jsp_build">
		<mkdir dir="work" />


		<javac destdir="${yukon-web}/work" fork="true" srcdir="${yukon-web}/WebContent_temp" 
			optimize="off" target="${yukon.javac.target}" 
	 	    source="${yukon.javac.source}" debug="${yukon.javac.debug}"
			failonerror="false" excludes="**/*.smap" 
			memoryInitialSize="128M" memoryMaximumSize="512M" debuglevel="lines">
			<classpath>
				<pathelement location="../build/jasper-compiler.jar" />
				<pathelement location="../build/jasper-runtime.jar" />
				<pathelement location="../build/ant.jar" />


				<fileset dir="${yukon.lib}">
					<include name="**/*.jar" />
				</fileset>

				<fileset dir="../third-party/">
					<include name="**/*.jar" />
				</fileset>
			</classpath>


		</javac>

	</target>
	<target name="build_webxml">
		<concat destfile="${yukon-web}/WebContent_temp/WEB-INF/generated_web.xml">
			<fileset dir="${yukon-web}/WebContent_temp/WEB-INF/webxml/">
				<include name="*.xml" />
			</fileset>
		</concat>
	</target>

	<target name="clean">
		<delete file="${yukon.lib}/yukon.war" />
		<delete dir="build" />
		<delete dir="${yukon.web.jsp_build}"/>
		<delete dir="${yukon.web.src_build}"/>

		<delete includeemptydirs="true" quiet="true">
			<fileset dir="${yukon-web}/WebContent_temp">
				<include name="**/*.java" />
			</fileset>
		</delete>
		<delete quiet="true">
			<fileset dir="${yukon-web}/WebContent_build">
				<include name="**/*.java" />
			</fileset>
		</delete>
		<delete dir="work" />
		<delete quiet="true">
			<fileset dir="WebContent_temp/WEB-INF/webxml/" />
		</delete>
		<delete file="WebContent_temp/WEB-INF/generated_web.xml"/>
	</target>

</project>







