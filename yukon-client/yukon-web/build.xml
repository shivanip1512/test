<?xml version="1.0" ?>
<project name="yukon web" default="all">

    <property environment="env"/>   
	<property file="../build/build.properties" />
	<property name="yukon.web.src_build" value="build_src"/>
    
    <path id="jspc.class.path">
        <fileset dir="${yukon.build}/lib">
            <include name="*.jar"/>
        </fileset>   
        <fileset dir="${yukon.lib}">
            <include name="**/*.jar"/>
        </fileset>   
        <fileset dir="${yukon-web}/WebContent/WEB-INF/lib">
            <include name="*.jar"/>
        </fileset>
    </path>   
	
	<target name="all" depends="clean, build" />

	<target name="install" depends="build">
        
		<jar jarfile="${yukon.client.bin}/yukon-web.jar" basedir="build/">
            <manifest>
                <attribute name="Yukon-Version" value="${yukon.build.version}"/>
                <attribute name="Yukon-Details" value="${yukon.build.details}"/>
            </manifest>
		</jar>
        
	</target>
    
    <target name="build.applets">
        <!-- This is meant to be run by hand, the output should be checked into CVS -->
        <javac srcdir="resources"
               destdir="${yukon-web}/WebContent/JavaScript"
               target="${yukon.javac.target}" 
               source="${yukon.javac.source}"
               bootclasspath="${yukon.javac.bootclasspath}"
               debug="${yukon.javac.debug}">
        </javac>
    </target>
	
	<target name="build" depends="build_src, war_precompiled"/>

    <!-- 
        Target to delete all of the files and directories from any previous builds
     -->
	<target name="clean">
        
		<delete file="${yukon.lib}/yukon.war" />
		<delete file="${yukon.lib}/yukon-web.jar" />
		<delete dir="build" />
		<delete dir="${yukon.web.src_build}"/>

        <delete dir="${yukon-web}/build_jsp" />
        <delete dir="${yukon-web}/WebContent_temp" />
        <delete dir="${yukon-web}/WebContent_merged" />      
        <delete file="${yukon-web}/generated_web.xml" />      

    </target>

	<target name="build_src">

		<mkdir dir="${yukon.web.src_build}" />

		<javac srcdir="src"
		       destdir="${yukon.web.src_build}"
		       target="${yukon.javac.target}" 
	 	       source="${yukon.javac.source}"
   		       bootclasspath="${yukon.javac.bootclasspath}"
		       debug="${yukon.javac.debug}">
			<classpath>
				<fileset dir="${yukon.lib}">
					<include name="**/*.jar" />
				</fileset>
                <fileset dir="${yukon-web}/WebContent/WEB-INF/lib">
                    <include name="*.jar"/>
                </fileset>
			</classpath>
		</javac>

		<jar jarfile="${yukon.lib}/yukon-web.jar" basedir="${yukon.web.src_build}">
            <manifest>
                <attribute name="Yukon-Version" value="${yukon.build.version}"/>
                <attribute name="Yukon-Details" value="${yukon.build.details}"/>
            </manifest>    
		    <fileset dir="src">
		 		<include name="**/*.xml"/>
			</fileset>
		</jar>
        
	</target>

    <!-- 
        Target to compile all of the .jsp files into .java files using jasper. 
        Also creates a new web.xml with generated elements
     -->
    <target name="precompile_jsp"> 
        
        <mkdir dir="${yukon-web}/WebContent_temp" />

        <!-- Define new task for jsp compilation -->   
        <taskdef classname="org.apache.jasper.JspC" name="jasper2">
            <classpath refid="jspc.class.path"/>
        </taskdef>

        <!-- Compile the .jsp files to .java -->   
        <jasper2 
            package="org.apache.jsp"
            validateXml="false"
            uriroot="${yukon-web}/WebContent"
            webXmlFragment="${yukon-web}/fragment_web.xml"
            outputDir="${yukon-web}/WebContent_temp" />

        <!-- Add generated web.xml fragment to the web.xml file -->   
        <echo>Adding generated_web.xml elements to web.xml</echo>

        <loadfile property="generated.xml" srcfile="${yukon-web}/fragment_web.xml"></loadfile>
        <copy file="${yukon-web}/WebContent/WEB-INF/web.xml" tofile="${yukon-web}/generated_web.xml" overwrite="true"/>
        <replace file="${yukon-web}/generated_web.xml" token="&lt;!-- [INSERT GENERATED WEB.XML FRAGMENT HERE] --&gt;" value="${generated.xml}"></replace>
        <delete file="${yukon-web}/fragment_web.xml"/>
     </target>
    
    <target name="precompile_java" depends="precompile_jsp">
       
        <mkdir dir="${yukon-web}/build_jsp" />
        <!-- Compile the .java files into .class files -->   
        <javac fork="true" 
               memoryMaximumSize="512M"
               srcdir="${yukon-web}/WebContent_temp"
               destdir="${yukon-web}/build_jsp"
               target="${yukon.javac.target}" 
               source="${yukon.javac.source}"
               bootclasspath="${yukon.javac.bootclasspath}"
               debug="${yukon.javac.debug}">
            <classpath refid="jspc.class.path"/>
        </javac>
        <jar jarfile="${yukon.lib}/yukon-web-jsp.jar" basedir="${yukon-web}/build_jsp/" excludes="*.xml *.jar"/>
        
    </target> 
 
    <!--
        Target to create a yukon.war file with precompiled jsps included
    -->   
    <target name="war_precompiled" depends="precompile_java">

        <mkdir dir="${yukon-web}/WebContent_merged"  />
                
        <!-- Copy all of the necessary web application files into the deploy directory -->   
        <copy todir="${yukon-web}/WebContent_merged" includeemptydirs="false">
            <fileset dir="${yukon-web}/WebContent">
                <exclude name="**/CVS" />
                <exclude name="WEB-INF/web.xml" />
                <exclude name="WEB-INF/classes/**" />
                <exclude name="**/.*" />
                <exclude name="**/build.xml" />
                <exclude name="**/*.jsp" />
                <exclude name="**/*.jspf" />
            </fileset>
        </copy>

        <!-- Copy all of the library jars from the yukon lib directory into the WebContent_merged/WEB-INF/lib 
        directory to be included in the war -->
        <copy todir="${yukon-web}/WebContent_merged/WEB-INF/lib" flatten="true">
           <fileset dir="${yukon.lib}" >
              <include name="**/*.jar" />
              <exclude name="jsp-api.jar"/>
              <exclude name="servlet-api.jar"/>
           </fileset>
        </copy>

        <!-- Copy the dummy login.jsp file into the deploy directory to be included in the war -->   
        <copy todir="${yukon-web}/WebContent_merged" flatten="true" file="${yukon-web}/resources/login.jsp" overwrite="true"/>

        <!-- Create the war file in the yukon lib directory from the 
        contents of the yukon-web deploy directory -->   
        <war destfile="${yukon.lib}/yukon.war" basedir="${yukon-web}/WebContent_merged"
            webxml="${yukon-web}/generated_web.xml" duplicate="preserve">
        </war>  
        
    </target>   
 
    <!--
        Target to deploy the yukon.war and yukon.xml files to the tomcat home directory
    -->   
    <target name="deploy_precompiled_war">
        
        <mkdir dir="${tomcat.home}/webapps/yukon"/>
        <unwar dest="${tomcat.home}/webapps/yukon" src="${yukon.lib}/yukon.war"/>
        <copy todir="${tomcat.home}/webapps" flatten="true" file="${yukon-web}/resources/yukon.xml" overwrite="true"/>
           
    </target>   
    
    <!--
        Old war target and staging directory (replaced by war_precompiled)
    -->   
	<property name="yukon.web.jsp_build" value="build_jsp_std"/>
    <target name="war_std">
        <mkdir dir="${yukon.web.jsp_build}"/>
        <copy todir="${yukon.web.jsp_build}">
            <fileset dir="${yukon-web}/WebContent">
                <exclude name="build/**" />
                <exclude name="jspbuild/**" />
                <exclude name="**/CVS" />
                <exclude name="WEB-INF/web.xml" />
                <exclude name="WEB-INF/classes/**" />
                <exclude name="**/.*" />
                <exclude name="**/build.xml" />
            </fileset>
        </copy>

        <!-- Put all the Yukon JAR files in here that are needed by the webserver -->
        <copy todir="${yukon.web.jsp_build}/WEB-INF/lib" flatten="true">
           <fileset dir="${yukon.lib}" >
              <include name="**/*.jar" />
              <exclude name="j2ee.jar"/>
           </fileset>
        </copy>

        <war destfile="${yukon.lib}/yukon.war" basedir="${yukon.web.jsp_build}"
            webxml="WebContent/WEB-INF/web.xml" duplicate="preserve">
        </war>

    </target>
    
</project>







