var ALL_POPUP_TYPES = {
	//types that are generated by the server
	//so the server knows about them
	subCommand: "SubCommand",
	feederCommand: "FeederCommand",
	capCommand: "CapCommand",
	subTag: "SubTag",
	feederTag: "FeederTag",
	capTag: "CapTag",
	capInfo: "CapInfo",	
	//types that are not known on the server
	//because they are the children 
	childCapMaint: "CapBankMaint",
	childCapDBChange:"CapDBChange",
	cbcPointTimestamp: "CapPtTmstmp",
    varChangePopup: "varChangePopup",
    bankMoveBack: "MoveBankBack",
    bankMove: "TempMoveBank",
    warningPopup: "WarningPopup",
    alertsPopup: "AlertsPopup",
    legend: "legend"
};

function resetCapOpCount(element, cmdId) {
    if (!element.checked) return;
    
    var newOpcntVal = prompt("What is the new value for Op Count?", "0");
    if (newOpcntVal == null) {
        element.checked = false;
        return;
    }
        
    var params = {};
    params['optParams'] = newOpcntVal;
    submitOnelineCommand(cmdId, params);
    return;
}

function submitToCapControlCommandController(url, params) {
    jQuery.ajax({
        url: url,
        method: 'POST',
        data: params,
        success: function(data) {
            display_status("Command sent successfully", "green");
         },
         error: function() {
             display_status("Command submission failed", "red");
         }
    });
}
	
function submitOnelineManualCommand(rawStateId) {
    var params = {};
    params['paoId'] = jQuery('#paoId').val();
    params['controlType'] = jQuery('#controlType').val();
    params['rawStateId'] = rawStateId;
    
    var url = jQuery('#manualUrl').val();
    submitToCapControlCommandController(url, params);
    closePopupWindow();        
}

function submitOnelineCommand(cmdId, params) {
    if (params == null) params = {};
    params['paoId'] = jQuery('#paoId').val();
    params['controlType'] = jQuery('#controlType').val();
    params['cmdId'] = cmdId;
    
    var url = jQuery('#url').val();
    submitToCapControlCommandController(url, params);
    closePopupWindow();        
}

function submitTagMenu(isCapBank) {

    var disableChange = jQuery('#disableCheckBox').is(':checked') != eval(jQuery('#disableCheckBox_orig').val());
    var disableOvUvChange = false;
    var disableOvUvValue = false;
    var disableOvUvCheckBox = jQuery('#disableOvUvCheckBox');
    if (disableOvUvCheckBox != null) {
        disableOvUvChange = jQuery('#disableOvUvCheckBox').is(':checked') != eval(jQuery('#disableOvUvCheckBox_orig').val());
        disableOvUvValue = jQuery('#disableOvUvCheckBox').is(':checked'); 
    }
    var disableOvUvReasonValue = "";
    var disableOvUvReason = jQuery('#disableOvUvReason');
    if (disableOvUvReason != null) {
        disableOvUvReasonValue = disableOvUvReason.val();
    }
    var operationalStateChange = false;

    if (isCapBank) {
        var state = jQuery('#operationalStateValue').val();
        var origState = jQuery('#operationalStateValue_orig').val();
        operationalStateChange = state != origState;
    }
    
    if (!(disableChange || disableOvUvChange || operationalStateChange)) {
        alert("No Change Was Made.");
        return false;   
    }
        
    params = {};
    params['paoId'] = jQuery('#paoId').val();
    params['controlType'] = jQuery('#controlType').val();
    
    params['disableCommandId'] = jQuery('#disableCommandId').val();
    params['enableCommandId'] = jQuery('#enableCommandId').val();
    params['disableOvUvCommandId'] = jQuery('#disableOvUvCommandId').val();
    params['enableOvUvCommandId'] = jQuery('#enableOvUvCommandId').val();
    
        
    params['disableValue'] = jQuery('#disableCheckBox').is(':checked');
    params['disableOvUvValue'] = disableOvUvValue;
    if (isCapBank) {
        params['operationalStateValue'] = jQuery("#operationalStateValue").val();
    }
        
    params['disableChange'] = disableChange;
    params['disableOvUvChange'] = disableOvUvChange;
    params['operationalStateChange'] = operationalStateChange;
        
    params['disableReason'] = jQuery('#disableReason').val();
    params['disableOvUvReason'] = disableOvUvReasonValue;
    if (isCapBank) params['operationalStateReason'] = jQuery('#operationalStateReason').val();
        
    var confirmMessage = '';
    if (disableChange) confirmMessage += 'Enable/Disable State Change\n';
    if (disableOvUvChange) confirmMessage += 'Enable/Disable OV/UV Change\n';
    if (isCapBank && operationalStateChange) confirmMessage += 'Operational State Change';
        
    if (!confirm(confirmMessage)) return false;
        
    var url = jQuery('#url').val();
    submitToCapControlCommandController(url, params);
    closePopupWindow(); 
}

function toggleReason(element, reasonElementId) {
	if (element.tagName == 'INPUT') {
		if (element.checked) {
		    jQuery('#' + reasonElementId).show();
			var textareaArray = jQuery('#' + reasonElementId + ' TEXTAREA');
            textareaArray.attr('disabled', false);
	    } else {
            jQuery('#' + reasonElementId).hide();
        }
	}
	
    if (element.tagName == 'SELECT') {
        var textareaArray = jQuery('#' + reasonElementId + ' TEXTAREA');
        textareaArray.attr('disabled', false);
	}
}
	
function openPopupWin(elem, compositeIdType) {
    try {
        // svg elements
        x = elem.getBBox().x;
        y = elem.getBBox().y;
    } catch (error) {
        // html elements
        x = jQuery(elem).offset().left;
        y = jQuery(elem).offset().top;
    }
	currentPopup = new PopupWindow("controlrequest");
	currentPopup.offsetX = x;
	currentPopup.offsetY = y;
    
	currentPopup.autoHide();
	
	type = compositeIdType.split("_")[0];
	id = compositeIdType.split("_")[1];
	
    var menuName;
    
    if (type == ALL_POPUP_TYPES.subCommand) {
		menuName = 'subMenu';
	} else if (type == ALL_POPUP_TYPES.feederCommand) {
		menuName = 'feederMenu';
	} else if (type == ALL_POPUP_TYPES.capCommand) {
        menuName = 'capBankMenu';
	} else if (type == ALL_POPUP_TYPES.subTag) {
        menuName = 'subTagMenu';
	} else if (type == ALL_POPUP_TYPES.feederTag) {
        menuName = 'feederTagMenu';
	} else if (type == ALL_POPUP_TYPES.capTag) {
        menuName = 'capTagMenu';
	} else if (type == ALL_POPUP_TYPES.capInfo) {
        menuName = 'capInfoMenu';
	} else if (type == ALL_POPUP_TYPES.childCapMaint) {
        menuName = 'capBankMaint';
	} else if (type == ALL_POPUP_TYPES.childCapDBChange) {
        menuName = 'capBankDBChange';
	} else if (type == ALL_POPUP_TYPES.cbcPointTimestamp) {
        showPointTimestamps(id);
		return;
	} else if (type == ALL_POPUP_TYPES.varChangePopup) {
        menuName ='varChangePopup';
    } else if (type == ALL_POPUP_TYPES.bankMoveBack) {
    	menuName ='moveBankBackPopup';
    } else if (type == ALL_POPUP_TYPES.bankMove) {
    	menuName ='moveBankPopup';
    } else if (type == ALL_POPUP_TYPES.warningPopup) {
    	menuName = 'warningInfoPopop';
    } else if (type == ALL_POPUP_TYPES.alertsPopup) {
        jQuery.ajax({
            url: '/spring/common/alert/view?style=onelineAlertView',
            method: 'post',
            success: function(data) {
                showPopup(data);
            }
        });
        
        return;
    } else if (type == ALL_POPUP_TYPES.legend) {
        jQuery.ajax({
            url: '/spring/capcontrol/oneline/legend/view',
            method: 'get',
            success: function(data) {
                currentPopup.offsetX = window.innerWidth/2;
                currentPopup.offsetY = 0;
                showPopup(data);
            }
        });
        return;
    }

    var url = '/spring/capcontrol/oneline/popupmenu/' + menuName + '?id=' + id + '&returnUrl=' + window.location;
    getFromURL(url);
}

function getFromURL(url) {
    jQuery.ajax({
        url: url,
        method: 'post',
        success: function(data) {
            showPopup(data);
        }
    });
}

function showPopup(html) {
	
	currentPopup.populate(html);
	//over-ride this function since we
	//need to adjust table headers
	currentPopup.PopupWindow_showPopup = function () {
			PopupWindow_showPopup("popupanchor");
	}
	currentPopup.showPopup("popupanchor");
	window.parent.currentPopup = currentPopup;
	window.parent.document.getElementById("controlrequest").style.borderStyle = "solid";
	window.parent.document.getElementById("controlrequest").style.borderColor = "gray";
	window.parent.document.getElementById("controlrequest").style.borderWidth = "thin";
	window.parent.document.getElementById("controlrequest").style.backgroundColor = "black";
}

function closePopupWindow() {
	if (window.parent.currentPopup) {
        window.parent.currentPopup.hidePopup();
    }
}

function showPointTimestamps (cbcID) {
	
	var url = '/spring/capcontrol/oneline/popupmenu/pointTimestamp?cbcID=';
	url += cbcID;

	return GB_show('', url, 520, 700);
}

//over-ridden function from PopupWindow.js
function PopupWindow_showPopup (anchorname) {
	this.anchorname = anchorname;
	this.getXYPosition(anchorname);
	this.x += this.offsetX;
	this.y += this.offsetY;
	if (!this.populated && (this.contents != "")) {
		this.populated = true;
		this.refresh();
		
		}
	if (this.divName != null) {
		// Show the DIV object
		if (this.use_gebi) {
			window.parent.document.getElementById(this.divName).style.left = this.x + "px";
			window.parent.document.getElementById(this.divName).style.top = this.y + "px";
			window.parent.document.getElementById(this.divName).style.visibility = "visible";
			}
		else if (this.use_css) {
			document.all[this.divName].style.left = this.x;
			document.all[this.divName].style.top = this.y;
			document.all[this.divName].style.visibility = "visible";
			
			
			}
		else if (this.use_layers) {
			document.layers[this.divName].left = this.x;
			document.layers[this.divName].top = this.y;
			document.layers[this.divName].visibility = "visible";
			}
		}
	else {
		if (this.popupWindow == null || this.popupWindow.closed) {
			// If the popup window will go off-screen, move it so it doesn't
			if (this.x<0) { this.x=0; }
			if (this.y<0) { this.y=0; }
			if (screen && screen.availHeight) {
				if ((this.y + this.height) > screen.availHeight) {
					this.y = screen.availHeight - this.height;
					}
				}
			if (screen && screen.availWidth) {
				if ((this.x + this.width) > screen.availWidth) {
					this.x = screen.availWidth - this.width;
					}
				}
			var avoidAboutBlank = window.opera || ( document.layers && !navigator.mimeTypes['*'] ) || navigator.vendor == 'KDE' || ( document.childNodes && !document.all && !navigator.taintEnabled );
			this.popupWindow = window.open(avoidAboutBlank?"":"about:blank","window_"+anchorname,this.windowProperties+",width="+this.width+",height="+this.height+",screenX="+this.x+",left="+this.x+",screenY="+this.y+",top="+this.y+"");
			}
		this.refresh();
		}
}

function showMoveBankPage(paoId) {
    window.location = '/spring/capcontrol/move/bankMove?bankid=' + paoId + '&oneline=true';
}

/**
 * Show a flyover popup using the overlib popup 
 * with the supplied html.
 * @param text
 * @return
 */
function showFlyoverPopup(html) {
	overlib( html, BGCOLOR, '#FFFFFF', FGCOLOR, '#404040', TEXTCOLOR, '#FFFFFF', LEFT);
}